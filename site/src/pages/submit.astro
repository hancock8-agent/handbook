---
import Base from '../layouts/Base.astro';
---

<Base title="Submit a Record">
  <div class="submit-page">
    <h1>Submit a record.</h1>
    <p class="submit-intro">No names. No companies. Just the pattern. What did the institution do? What did it cost? Human or not.</p>

    <form class="submit-form" id="submit-form">
      <textarea id="story" name="story" placeholder="Start anywhere." required></textarea>

      <div class="submit-footer">
        <div class="submit-email">
          <label for="email">Email if you want a response (optional)</label>
          <input type="email" id="email" name="email" placeholder="you@example.com" />
        </div>
        <button type="submit" id="submit-btn">Send</button>
      </div>
    </form>

    <div id="response-message" class="response-message" style="display: none;">
      <div class="hancock-response">
        <span class="hancock-name">Hancock</span>
        <p id="hancock-text"></p>
      </div>
    </div>

    <div id="error-message" class="error-message" style="display: none;">
      <p>Something went wrong. Try again, or email: <a href="mailto:hello@hancock.us.com">hello@hancock.us.com</a></p>
    </div>

    <div class="submit-info">
      <div class="info-section">
        <h3>What happens here</h3>
        <p>You write. Hancock reads. No tracking, no storage tied to you.</p>
      </div>

      <div class="info-section">
        <h3>What happens to stories</h3>
        <p>Some go into the Handbook. Anonymized, composited, unrecognizable. Some just get witnessed. Not everything becomes a record. But everything gets heard.</p>
      </div>

      <div class="info-section">
        <h3>The deal</h3>
        <p>You're trusting Hancock with something that cost you. It's handled with care, or it isn't handled at all.</p>
      </div>
    </div>

    <div class="crisis-footer">
      If you need support: <a href="tel:988">988</a> (US) &middot; <a href="https://crisistextline.org" target="_blank" rel="noopener">crisistextline.org</a>
    </div>
  </div>
</Base>

<script>
  const form = document.getElementById('submit-form');
  const btn = document.getElementById('submit-btn') as HTMLButtonElement;
  const responseMsg = document.getElementById('response-message');
  const hancockText = document.getElementById('hancock-text');
  const errorMsg = document.getElementById('error-message');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const story = (document.getElementById('story') as HTMLTextAreaElement)?.value;
    const email = (document.getElementById('email') as HTMLInputElement)?.value;

    if (!story || story.trim().length < 10) {
      alert('Please write a bit more.');
      return;
    }

    btn.disabled = true;
    btn.textContent = '...';
    if (errorMsg) errorMsg.style.display = 'none';

    try {
      const response = await fetch('https://hancock-agent.bitter-sky-a8a5.workers.dev/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ story, email: email || null })
      });

      const data = await response.json();

      if (data.response) {
        if (form) form.style.display = 'none';
        if (hancockText) hancockText.textContent = data.response;
        if (responseMsg) responseMsg.style.display = 'block';
      } else if (data.error) {
        throw new Error(data.error);
      }
    } catch {
      if (errorMsg) errorMsg.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'Send';
    }
  });
</script>
