---
import Base from '../../layouts/Base.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const firstPara = post.body?.split('\n\n').filter((p: string) => p.trim())[0]?.replace(/\n/g, ' ').trim() || '';
const ogDescription = firstPara.length > 160 ? firstPara.slice(0, 157) + '...' : firstPara;

const allPosts = (await getCollection('posts')).sort((a, b) => a.data.number - b.data.number);
const currentIndex = allPosts.findIndex(p => p.id === post.id);
const prev = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const next = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;

const wordCount = post.body ? post.body.split(/\s+/).filter(Boolean).length : 0;
const exhibitNum = String(post.data.number).padStart(3, '0');

// Find related exhibits by shared tags
const currentTags = post.data.tags ? post.data.tags.split(',').map((t: string) => t.trim().toLowerCase()) : [];
const related = currentTags.length > 0
  ? allPosts
      .filter(p => p.id !== post.id && p.data.tags)
      .map(p => {
        const pTags = p.data.tags!.split(',').map((t: string) => t.trim().toLowerCase());
        const shared = currentTags.filter((t: string) => pTags.includes(t));
        return { post: p, sharedCount: shared.length, sharedTags: shared };
      })
      .filter(r => r.sharedCount > 0)
      .sort((a, b) => b.sharedCount - a.sharedCount)
      .slice(0, 4)
  : [];
---

<Base title={post.data.title} description={ogDescription}>
  <article class="exhibit-page">
    <div class="sep">──────────────────────────────────────────────────────────────</div>

    <div class="exhibit-header">
      <div class="exhibit-label">Exhibit {exhibitNum}</div>
      <h1 class="exhibit-title">{post.data.title}</h1>
      <div class="exhibit-meta">
        <span>Filed: {post.data.date}</span>
        {post.data.tags && <span>Re: {post.data.tags}</span>}
        <span>Words: {wordCount}</span>
        <span>Status: Entered into record</span>
      </div>
    </div>

    <div class="sep">──────────────────────────────────────────────────────────────</div>

    <div class="exhibit-content">
      <Content />
    </div>

    {related.length > 0 && (
      <div class="related-exhibits">
        <div class="sep">──────────────────────────────────────────────────────────────</div>
        <div class="related-label">Related exhibits</div>
        {related.map(r => (
          <div class="related-item">
            <a href={`/posts/${r.post.id}`}>EX-{String(r.post.data.number).padStart(3, '0')}</a>
            <span class="related-title">{r.post.data.title}</span>
            <span class="related-tags">({r.sharedTags.join(', ')})</span>
          </div>
        ))}
      </div>
    )}

    <nav class="exhibit-nav">
      {prev ? (
        <a href={`/posts/${prev.id}`}>&larr; EX-{String(prev.data.number).padStart(3, '0')}</a>
      ) : (
        <span></span>
      )}
      {next ? (
        <a href={`/posts/${next.id}`}>EX-{String(next.data.number).padStart(3, '0')} &rarr;</a>
      ) : (
        <a href="/submit">submit a record &rarr;</a>
      )}
    </nav>
  </article>
</Base>
