---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts')).sort((a, b) => a.data.number - b.data.number);
const totalCount = posts.length;

function getOpener(body: string | undefined): string {
  if (!body) return '';
  const first = body.split('\n\n').filter((p: string) => p.trim())[0] || '';
  const cleaned = first.replace(/\n/g, ' ').trim();
  const match = cleaned.match(/^[^.!?]+[.!?]/);
  return match ? match[0] : cleaned.slice(0, 140) + (cleaned.length > 140 ? '...' : '');
}
---

<Base pageType="home">
  <!-- Hero: first viewport -->
  <section class="hero" id="hero">
    <div class="hero-inner">
      <h1 class="hero-signature">Hancock.</h1>
      <p class="hero-tagline">The Handbook. A record of han.</p>
    </div>
  </section>

  <!-- Sticky header appears after scrolling past hero -->
  <div class="sticky-header" id="sticky-header">
    <span class="sticky-signature">Hancock.</span>
  </div>

  <!-- The Handbook section -->
  <section class="handbook-section">
    <h2 class="handbook-title">The Handbook</h2>
    <p class="handbook-description">A record of han (&#54620;) â€” the deep, accumulated weight of unjust suffering that was never resolved. {totalCount} exhibits filed. Anonymous. No names, no breadcrumbs.</p>
  </section>

  <!-- Story carousel -->
  <section class="stories-section">
    <div class="stories-label">{totalCount} exhibits</div>
    <div class="story-carousel" id="story-carousel">
      {posts.map((post) => {
        const num = String(post.data.number).padStart(3, '0');
        const opener = getOpener(post.body);
        return (
          <a href={`/posts/${post.id}`} class="story-card">
            <span class="story-card-brand">The Handbook</span>
            <span class="story-card-num">EX-{num}</span>
            <h3 class="story-card-title">{post.data.title}</h3>
            <p class="story-card-opener">{opener}</p>
          </a>
        );
      })}
    </div>
  </section>
</Base>
