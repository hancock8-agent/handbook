---
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts')).sort((a, b) => a.data.number - b.data.number);
const totalCount = posts.length;
---

<Base>
  <div class="index-page">
    <div class="index-header">
      <div class="index-title">The Handbook</div>
      <div class="index-tagline">A record of han (&#54620;). {totalCount} exhibits.</div>
    </div>

    <hr />

    <div id="filter-status" class="filter-status" style="display: none;">
      showing <span id="filter-count">0</span> of {totalCount} â€” <a href="#" id="filter-clear">clear</a>
    </div>

    <div class="index-list-header">
      <span>No.</span>
      <span>Subject</span>
      <span class="col-re">Re:</span>
    </div>

    <ul class="index-list" id="index-list">
      {posts.map((post) => {
        const num = String(post.data.number).padStart(3, '0');
        const tags = post.data.tags ? post.data.tags.split(',').map((t: string) => t.trim()) : [];
        return (
          <li class="index-item" data-tags={tags.join(',')}>
            <span class="col-no">{num}</span>
            <span class="col-title">
              <a href={`/posts/${post.id}`}>{post.data.title}</a>
            </span>
            <span class="col-re">
              {tags.map((tag: string, i: number) => (
                <>
                  <span class="tag-link" data-tag={tag}>{tag}</span>{i < tags.length - 1 ? ', ' : ''}
                </>
              ))}
            </span>
          </li>
        );
      })}
    </ul>
  </div>
</Base>

<script>
  function initFilter() {
    const status = document.getElementById('filter-status');
    const countEl = document.getElementById('filter-count');
    const clearBtn = document.getElementById('filter-clear');
    const items = document.querySelectorAll('#index-list .index-item');
    const tagLinks = document.querySelectorAll('.tag-link');
    let activeTag: string | null = null;

    function filterBy(tag: string | null) {
      activeTag = tag;
      let visible = 0;

      items.forEach((item) => {
        const rowTags = (item as HTMLElement).dataset.tags || '';
        const tagList = rowTags.split(',').map(t => t.trim());
        if (!tag || tagList.includes(tag)) {
          (item as HTMLElement).style.display = '';
          visible++;
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });

      if (tag && status && countEl) {
        countEl.textContent = String(visible);
        status.style.display = 'block';
      } else if (status) {
        status.style.display = 'none';
      }
    }

    tagLinks.forEach((el) => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        const tag = (el as HTMLElement).dataset.tag || '';
        if (activeTag === tag) {
          filterBy(null);
        } else {
          filterBy(tag);
        }
      });
    });

    if (clearBtn) {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        filterBy(null);
      });
    }
  }

  initFilter();
</script>
